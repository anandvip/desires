<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Desire Tracker</title>
  <style>
    /* ====== [ START OF STYLES - Same as Original + Toast Styles ] ====== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #2d3748;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      font-weight: 700;
    }
    .input-methods {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .mic-btn {
      background: #48bb78;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mic-btn.recording {
      background: #f56565;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .desire-form {
      display: grid;
      gap: 20px;
      margin-bottom: 30px;
    }
    .form-group {
      display: grid;
      gap: 8px;
    }
    label {
      font-weight: 600;
      color: #4a5568;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }
    .desires-list {
      display: grid;
      gap: 20px;
    }
    .desire-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
      cursor: move;
      position: relative;
    }
    .desire-card.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }
    .desire-card::before {
      content: '‚ãÆ‚ãÆ';
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #a0aec0;
      font-size: 20px;
      cursor: move;
    }
    .desire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-left: 30px;
    }
    .desire-title {
      font-size: 1.25em;
      font-weight: 600;
      color: #2d3748;
    }
    .desire-priority {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    .priority-high { background: #fed7d7; color: #c53030; }
    .priority-medium { background: #feebc8; color: #c05621; }
    .priority-low { background: #c6f6d5; color: #2f855a; }
    .desire-description {
      color: #4a5568;
      margin-bottom: 15px;
      line-height: 1.5;
      padding-left: 30px;
    }
    .state-notes {
      margin: 15px 0;
      padding: 15px 30px;
      background: #f7fafc;
      border-radius: 8px;
    }
    .state-note {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .state-note:last-child {
      border-bottom: none;
    }
    .state-note-date {
      font-size: 0.85em;
      color: #718096;
      margin-right: 10px;
    }
    .state-note-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .state-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .state-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 12px;
      font-size: 14px;
      background: #4a5568;
      color: white;
      border-radius: 6px;
    }
    .state-btn:hover {
      background: #2d3748;
    }
    .state-input-group {
      display: none;
      margin-top: 10px;
    }
    .state-input-group.active {
      display: block;
    }
    .state-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .desire-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e2e8f0;
      padding-left: 30px;
    }
    .desire-date {
      color: #718096;
      font-size: 14px;
    }
    .delete-btn {
      background: #fc8181;
      padding: 8px 16px;
      font-size: 14px;
    }
    .delete-btn:hover {
      background: #f56565;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #718096;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .recognition-status {
      text-align: center;
      margin: 10px 0;
      font-style: italic;
      color: #718096;
    }
    /* Toast Notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #48bb78; /* success green */
      color: #fff;
      padding: 15px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 9999;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s, transform 0.3s;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ú® Desire Tracker</h1>

    <!-- Google Sign-in Button -->
    <div class="input-methods" style="margin-bottom:30px;">
      <button id="googleSignInBtn" style="background:#fcbd45;">
        üîë Sign In with Google
      </button>
    </div>
    
    <div class="input-methods">
      <button id="micBtn" class="mic-btn">
        üé§ Start Dictation
      </button>
      <button id="showFormBtn">
        ‚úèÔ∏è Manual Entry
      </button>
    </div>

    <form class="desire-form" id="desireForm">
      <div class="form-group">
        <label for="desireTitle">What's your desire?</label>
        <input type="text" id="desireTitle" required placeholder="Enter your desire...">
      </div>

      <div class="form-group">
        <label for="desireDescription">Description</label>
        <textarea id="desireDescription" placeholder="Describe your desire in detail..."></textarea>
      </div>

      <div class="form-group">
        <label for="desirePriority">Priority Level</label>
        <select id="desirePriority">
          <option value="low">Low Priority</option>
          <option value="medium">Medium Priority</option>
          <option value="high">High Priority</option>
        </select>
      </div>

      <button type="submit">Add Desire</button>
    </form>

    <div id="desiresList" class="desires-list"></div>
  </div>

  <!-- Modal for speech recognition -->
  <div id="speechModal" class="modal">
    <div class="modal-content">
      <h2>Speech Recognition</h2>
      <p id="recognitionStatus" class="recognition-status">Listening...</p>
      <div id="recognizedText"></div>
      <button id="confirmSpeech">Confirm</button>
      <button id="cancelSpeech">Cancel</button>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="toast"></div>

  <!-- ========================================================= -->
  <!-- 1) Firebase Module Script (Production Mode) -->
  <!--    Keep separate from the main app logic, but in the same file -->
  <!-- ========================================================= -->
  <script type="module">
    /* 
      Firebase initialization and Firestore logic
      - We'll expose these functions on window so the main script can call them
    */
    import { 
      initializeApp 
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";

    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      setDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCLfBy9R_tL8WPRJpmKZMcy70OzhId9V1w",
      authDomain: "desires-b59a7.firebaseapp.com",
      projectId: "desires-b59a7",
      storageBucket: "desires-b59a7.firebasestorage.app",
      messagingSenderId: "942109661123",
      appId: "1:942109661123:web:84f2532a442f9d49bb8f76"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Prepare Google Auth
    const provider = new GoogleAuthProvider();

    // Expose signInWithGoogle on window
    window.signInWithGoogle = async function() {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error("Google sign-in error:", error);
        throw error;
      }
    };

    // Expose onAuthChange on window
    window.onAuthChange = function(callback) {
      onAuthStateChanged(auth, (user) => {
        callback(user);
      });
    };

    /* Firestore CRUD */

    function getUserDesiresCollection(uid) {
      return collection(db, "users", uid, "desires");
    }

    async function fetchAllDesires(uid) {
      const userRef = getUserDesiresCollection(uid);
      const snapshot = await getDocs(userRef);
      const result = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        // Convert the doc ID to a number if it was saved as string
        result.push({ ...data, id: parseInt(docSnap.id, 10) });
      });
      return result;
    }

    async function saveDesire(uid, desire) {
      const userRef = getUserDesiresCollection(uid);
      const desireRef = doc(userRef, desire.id.toString());
      await setDoc(desireRef, desire);
    }

    async function bulkSaveDesires(uid, desires) {
      for (const desire of desires) {
        await saveDesire(uid, desire);
      }
    }

    // Expose syncLocalDataWithFirestore
    window.syncLocalDataWithFirestore = async function(uid, localDesires) {
      // 1. Fetch from Firestore
      const firestoreDesires = await fetchAllDesires(uid);

      // 2. Merge by ID (local overwrites if conflicts)
      const mergedMap = new Map();
      // Put Firestore items
      firestoreDesires.forEach(d => mergedMap.set(d.id, d));
      // Overwrite/insert local
      localDesires.forEach(d => mergedMap.set(d.id, d));

      // Convert map back to array
      const mergedList = Array.from(mergedMap.values());

      // 3. Save union to local storage
      localStorage.setItem('desires', JSON.stringify(mergedList));

      // 4. Save union to Firestore
      await bulkSaveDesires(uid, mergedList);

      return mergedList;
    };
  </script>

  <!-- ========================================================= -->
  <!-- 2) Main Application Script -->
  <!-- ========================================================= -->
  <script>
    /***************************************************************
     * DesireTracker Class
     *   - Uses local storage for primary CRUD
     *   - Hooks into Firebase on sign-in to sync data
     ***************************************************************/
    class DesireTracker {
      constructor() {
        // Local storage data
        this.desires = JSON.parse(localStorage.getItem('desires')) || [];

        // Basic UI elements
        this.form = document.getElementById('desireForm');
        this.list = document.getElementById('desiresList');
        this.micBtn = document.getElementById('micBtn');
        this.recognition = null;
        this.isRecording = false;
        this.activeRecordingId = null;

        // Auth state
        this.currentUser = null;

        // Init
        this.initialize();
        this.initializeSpeechRecognition();
        this.initializeDragAndDrop();
        this.listenToAuthChanges();
      }

      /*===============================================================
        Basic initialization
      ==============================================================*/
      initialize() {
        // Form submission
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));

        // Microphone button
        this.micBtn.addEventListener('click', () => this.toggleSpeechRecognition());

        // Display existing desires
        this.displayDesires();

        // Google Sign-In
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        googleSignInBtn.addEventListener('click', async () => {
          try {
            await window.signInWithGoogle();
          } catch (err) {
            alert('Sign-in failed or canceled.');
          }
        });
      }

      /*===============================================================
        Listen to Auth Changes
      ==============================================================*/
      listenToAuthChanges() {
        window.onAuthChange(async (user) => {
          this.currentUser = user;
          if (user) {
            // Sync local data with Firestore
            try {
              const merged = await window.syncLocalDataWithFirestore(user.uid, this.desires);
              // Update local array
              this.desires = merged;
              // Refresh UI
              this.displayDesires();
              // Show success toast
              this.showToast("Congratulations! Your data has been synced to Firestore successfully.");
            } catch (error) {
              console.error("Sync error:", error);
              this.showToast("Firestore sync failed. Continuing with local data only.", true);
            }
          } else {
            // Not signed in, do nothing special
            console.log("User not signed in.");
          }
        });
      }

      /*===============================================================
        Toast Notification (Self-closing)
      ==============================================================*/
      showToast(message, isError = false) {
        const toastEl = document.getElementById('toast');
        toastEl.innerText = message;
        toastEl.style.background = isError ? '#f56565' : '#48bb78';
        toastEl.classList.add('show');
        setTimeout(() => {
          toastEl.classList.remove('show');
        }, 3000); // hide after 3s
      }

      /*===============================================================
        Speech Recognition Setup
      ==============================================================*/
      initializeSpeechRecognition() {
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          this.recognition = new SpeechRecognition();
          this.recognition.continuous = true;
          this.recognition.interimResults = true;

          this.recognition.onstart = () => {
            this.isRecording = true;
            this.updateRecordingUI(true);
          };

          this.recognition.onend = () => {
            this.isRecording = false;
            this.updateRecordingUI(false);
          };

          this.recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            this.stopSpeechRecognition();
          };
        } else {
          this.micBtn.style.display = 'none';
          console.warn('Speech recognition not supported in this browser.');
        }
      }

      updateRecordingUI(isRecording) {
        const button = this.activeRecordingId 
          ? document.querySelector(`button[data-mic="${this.activeRecordingId}"]`)
          : this.micBtn;

        if (button) {
          if (isRecording) {
            button.classList.add('recording');
            button.textContent = this.activeRecordingId
              ? 'üé§ Stop Recording'
              : 'üé§ Stop Dictation';
          } else {
            button.classList.remove('recording');
            button.textContent = this.activeRecordingId
              ? 'üé§ Add Voice Note'
              : 'üé§ Start Dictation';
          }
        }
      }

      async toggleSpeechRecognition(desireId = null) {
        try {
          if (this.isRecording) {
            this.stopSpeechRecognition();
          } else {
            await navigator.mediaDevices.getUserMedia({ audio: true });
            this.activeRecordingId = desireId;
            this.startSpeechRecognition();
          }
        } catch (error) {
          console.error('Microphone permission denied:', error);
          alert('Please allow microphone access to use speech recognition.');
        }
      }

      startSpeechRecognition() {
        if (this.recognition) {
          this.recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript + ' ';
              }
            }
            if (finalTranscript) {
              if (this.activeRecordingId) {
                this.addStateNote(this.activeRecordingId, finalTranscript.trim());
              } else {
                document.getElementById('desireTitle').value = finalTranscript.trim();
              }
              this.stopSpeechRecognition();
            }
          };
          this.recognition.start();
        }
      }

      stopSpeechRecognition() {
        if (this.recognition) {
          this.recognition.stop();
          this.isRecording = false;
          this.activeRecordingId = null;
        }
      }

      /*===============================================================
        Drag-and-Drop Reordering
      ==============================================================*/
      initializeDragAndDrop() {
        this.list.addEventListener('dragstart', (e) => {
          if (e.target.classList.contains('desire-card')) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
          }
        });

        this.list.addEventListener('dragend', (e) => {
          if (e.target.classList.contains('desire-card')) {
            e.target.classList.remove('dragging');
          }
        });

        this.list.addEventListener('dragover', (e) => {
          e.preventDefault();
          const afterElement = this.getDragAfterElement(this.list, e.clientY);
          const draggable = document.querySelector('.dragging');
          if (afterElement) {
            this.list.insertBefore(draggable, afterElement);
          } else {
            this.list.appendChild(draggable);
          }
        });

        this.list.addEventListener('drop', (e) => {
          e.preventDefault();
          this.updateDesireOrder();
        });
      }

      getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.desire-card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

      updateDesireOrder() {
        const cards = [...this.list.querySelectorAll('.desire-card')];
        const newOrder = cards.map(card => {
          return this.desires.find(d => d.id === parseInt(card.dataset.id));
        });
        this.desires = newOrder;
        this.saveDesires();
      }

      /*===============================================================
        Form Submission
      ==============================================================*/
      handleSubmit(e) {
        e.preventDefault();
        const desire = {
          id: Date.now(),
          title: document.getElementById('desireTitle').value,
          description: document.getElementById('desireDescription').value,
          priority: document.getElementById('desirePriority').value,
          date: new Date().toISOString(),
          stateNotes: []
        };
        this.desires.unshift(desire);
        this.saveDesires();
        this.displayDesires();
        this.form.reset();
      }

      /*===============================================================
        State Notes
      ==============================================================*/
      addStateNote(desireId, note) {
        const desire = this.desires.find(d => d.id === desireId);
        if (desire) {
          desire.stateNotes.unshift({
            id: Date.now(),
            text: note,
            date: new Date().toISOString()
          });
          this.saveDesires();
          this.displayDesires();
        }
      }

      deleteStateNote(desireId, noteId) {
        const desire = this.desires.find(d => d.id === desireId);
        if (desire) {
          desire.stateNotes = desire.stateNotes.filter(n => n.id !== noteId);
          this.saveDesires();
          this.displayDesires();
        }
      }

      /*===============================================================
        Delete Entire Desire
      ==============================================================*/
      deleteDesire(id) {
        this.desires = this.desires.filter(d => d.id !== id);
        this.saveDesires();
        this.displayDesires();
      }

      /*===============================================================
        Local Storage Persistence
      ==============================================================*/
      saveDesires() {
        localStorage.setItem('desires', JSON.stringify(this.desires));
      }

      /*===============================================================
        Helper: Format Date
      ==============================================================*/
      formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      /*===============================================================
        Toggle Input for Voice vs. Text
      ==============================================================*/
      toggleStateInput(desireId, inputType) {
        const inputGroup = document.querySelector(`.state-input-group[data-desire="${desireId}"]`);
        if (inputGroup) {
          if (inputType === 'voice') {
            this.toggleSpeechRecognition(desireId);
          } else {
            inputGroup.classList.toggle('active');
            if (inputGroup.classList.contains('active')) {
              inputGroup.querySelector('input').focus();
            }
          }
        }
      }

      /*===============================================================
        Render UI
      ==============================================================*/
      displayDesires() {
        if (this.desires.length === 0) {
          this.list.innerHTML = `
            <div class="empty-state">
              <h3>No desires added yet</h3>
              <p>Start by adding your first desire using voice or text input!</p>
            </div>
          `;
          return;
        }

        this.list.innerHTML = this.desires.map(desire => `
          <div class="desire-card" draggable="true" data-id="${desire.id}">
            <div class="desire-header">
              <h3 class="desire-title">${desire.title}</h3>
              <span class="desire-priority priority-${desire.priority}">
                ${desire.priority.charAt(0).toUpperCase() + desire.priority.slice(1)}
              </span>
            </div>
            <p class="desire-description">${desire.description || 'No description provided'}</p>

            <div class="state-notes">
              <h4>State Notes</h4>
              ${desire.stateNotes.map(note => `
                <div class="state-note">
                  <span>${note.text}</span>
                  <div class="state-note-actions">
                    <span class="state-note-date">${this.formatDate(note.date)}</span>
                    <button onclick="event.stopPropagation(); desireTracker.deleteStateNote(${desire.id}, ${note.id})">
                      ‚ùå
                    </button>
                  </div>
                </div>
              `).join('')}

              <div class="state-actions">
                <button class="state-btn" 
                        data-mic="${desire.id}"
                        onclick="event.stopPropagation(); desireTracker.toggleStateInput(${desire.id}, 'voice')">
                  üé§ Add Voice Note
                </button>
                <button class="state-btn"
                        onclick="event.stopPropagation(); desireTracker.toggleStateInput(${desire.id}, 'text')">
                  ‚úèÔ∏è Add Text Note
                </button>
              </div>

              <div class="state-input-group" data-desire="${desire.id}">
                <input type="text" 
                       class="state-input" 
                       placeholder="Enter your state note..."
                       onkeypress="if(event.key === 'Enter') {
                         desireTracker.addStateNote(${desire.id}, this.value);
                         this.value = '';
                         this.parentElement.classList.remove('active');
                       }">
              </div>
            </div>

            <div class="desire-footer">
              <span class="desire-date">${this.formatDate(desire.date)}</span>
              <button class="delete-btn" onclick="event.stopPropagation(); desireTracker.deleteDesire(${desire.id})">
                Delete
              </button>
            </div>
          </div>
        `).join('');
      }
    }

    // Initialize globally so inline onclick handlers can access it
    window.desireTracker = new DesireTracker();
  </script>
</body>
</html>
